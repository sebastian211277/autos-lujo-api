<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autos Luxury - Cat치logo Maestro</title>
    <style>
        body { font-family: 'Helvetica Neue', sans-serif; background-color: #0a0a0a; color: #fff; margin: 0; }
        
        /* Header */
        header { padding: 20px 40px; border-bottom: 1px solid #333; background: #000; position: sticky; top: 0; z-index: 100; }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        h1 { color: #d4af37; text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; margin: 0; }
        
        .search-container { flex-grow: 1; max-width: 400px; }
        .search-input { 
            width: 100%; padding: 10px 20px; background: #1a1a1a; border: 1px solid #333; 
            border-radius: 25px; color: white; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: #d4af37; }

        /* Grid & Cards */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; min-height: 60vh; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .card { background: #1a1a1a; border-radius: 8px; overflow: hidden; transition: 0.3s; cursor: pointer; border: 1px solid #333; }
        .card:hover { transform: translateY(-5px); border-color: #d4af37; }
        .card img { width: 100%; height: 220px; object-fit: cover; }
        .card-info { padding: 15px; }
        .card-price { color: #d4af37; font-weight: bold; margin-top: 5px; }

        /* PAGINACI칍N */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 50px 0; }
        .page-btn { 
            background: #1a1a1a; color: #d4af37; border: 1px solid #d4af37; padding: 10px 25px; 
            border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .page-btn:hover:not(:disabled) { background: #d4af37; color: black; }
        .page-btn:disabled { border-color: #333; color: #555; cursor: not-allowed; }
        #pageInfo { font-size: 0.9rem; letter-spacing: 1px; color: #888; }

        /* MODAL DE DETALLE (FICHA T칄CNICA) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; }
        .modal-content { 
            background: #151515; width: 90%; max-width: 1000px; height: 80vh; 
            display: grid; grid-template-columns: 1.5fr 1fr; border-radius: 8px; overflow: hidden; position: relative;
        }
        .modal-gallery { position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        .modal-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-details { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .detail-title { font-size: 2rem; color: #d4af37; margin: 0; }
        .detail-price { font-size: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 35px; color: #fff; cursor: pointer; z-index: 1001; }
        
        @media (max-width: 768px) { .modal-content { grid-template-columns: 1fr; height: 90vh; } }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <h1>Autos Luxury</h1>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar..." onkeyup="handleSearch()">
            </div>
            <a href="/login.html" style="color:#555; text-decoration:none; font-size:0.8rem;">Admin Access</a>
        </div>
    </header>

    <div class="container">
        <div id="grid" class="grid"></div>
        
        <div class="pagination">
            <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Anterior</button>
            <span id="pageInfo">P치gina 1 de 1</span>
            <button id="nextBtn" class="page-btn" onclick="changePage(1)">Siguiente</button>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div class="modal-gallery">
                <img id="modalImg" class="modal-img" src="">
            </div>
            <div class="modal-details">
                <h2 id="mTitle" class="detail-title">Cargando...</h2>
                <div class="detail-price">
                    <div id="mPriceUSD">USD $0</div>
                    <small id="mPriceMXN" style="color:#888;">MXN $0</small>
                </div>
                <p>游늰 <b>A침o:</b> <span id="mYear"></span></p>
                <p>游냁 <b>Potencia:</b> <span id="mHP"></span> HP</p>
                <div>
                    <h3>Description</h3>
                    <p id="mDesc" style="line-height:1.6; color:#ccc;"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const limit = 6;

        async function loadCars(page = 1) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<p style="text-align:center; width:100%;">Conectando con el inventario...</p>';

            try {
                const res = await fetch(`/api/cars?page=${page}&limit=${limit}`);
                const response = await res.json();
                
                if (response.success) {
                    renderCars(response.data);
                    currentPage = response.currentPage;
                    totalPages = response.totalPages;
                    updatePaginationUI();
                }
            } catch (error) {
                grid.innerHTML = '<p style="color:red;">Error de conexi칩n.</p>';
            }
        }

        function renderCars(cars) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            cars.forEach(car => {
                const carJson = JSON.stringify(car).replace(/'/g, "&#39;");
                const cover = (car.images && car.images.length) ? car.images[0] : 'https://via.placeholder.com/400';
                
                // AQU칈 ESTABA EL ERROR: Agregamos el onclick="openModal(...)"
                grid.innerHTML += `
                    <div class="card" onclick='openModal(${carJson})'>
                        <img src="${cover}">
                        <div class="card-info">
                            <h3 class="card-title">${car.make} ${car.model}</h3>
                            <div class="card-price">US $${car.price.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
        }

        function openModal(car) {
            // Llenamos los datos en el modal
            document.getElementById('mTitle').innerText = `${car.make} ${car.model}`;
            document.getElementById('mPriceUSD').innerText = `USD $${car.price.toLocaleString()}`;
            document.getElementById('mPriceMXN').innerText = `MXN $${(car.priceMXN || 0).toLocaleString()}`;
            document.getElementById('mYear').innerText = car.year;
            document.getElementById('mHP').innerText = car.horsepower;
            document.getElementById('mDesc').innerText = car.description || "Sin descripci칩n disponible.";
            document.getElementById('modalImg').src = (car.images && car.images.length) ? car.images[0] : '';

            // Mostramos el modal
            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function updatePaginationUI() {
            document.getElementById('pageInfo').innerText = `P치gina ${currentPage} de ${totalPages}`;
            document.getElementById('prevBtn').disabled = (currentPage === 1);
            document.getElementById('nextBtn').disabled = (currentPage === totalPages || totalPages === 0);
        }

        function changePage(step) {
            const newPage = currentPage + step;
            if (newPage >= 1 && newPage <= totalPages) {
                loadCars(newPage);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (term === "") { loadCars(1); return; }

            fetch('/api/cars?limit=100').then(res => res.json()).then(response => {
                const filtered = response.data.filter(c => 
                    c.make.toLowerCase().includes(term) || c.model.toLowerCase().includes(term)
                );
                renderCars(filtered);
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('pageInfo').innerText = "Resultados de b칰squeda";
            });
        }

        // Cerrar modal si hacen clic fuera o presionan Escape
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailModal')) closeModal();
        }
        window.onkeydown = function(e) { if(e.key === "Escape") closeModal(); }

        loadCars(1);
    </script>
</body>
</html>