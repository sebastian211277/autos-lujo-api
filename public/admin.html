<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Autos de Lujo</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f4; max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-logout { background: #343a40; width: auto; }
        
        /* Previsualizaci√≥n de fotos */
        #preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; padding: 10px; border: 1px dashed #ccc; min-height: 80px; border-radius: 4px; background: #fafafa; }
        .preview-wrapper { position: relative; animation: fadeIn 0.5s; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; font-size: 12px; line-height: 20px; }

        .card { background: white; padding: 10px; margin-top: 10px; border-radius: 4px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
        .thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Gesti√≥n de Inventario</h1>
        <button class="btn btn-logout" onclick="logout()">Salir</button>
    </div>

    <div class="form-container">
        <h3 id="formTitle">Agregar / Editar Auto</h3>
        <form id="carForm">
            <input type="hidden" id="carId">
            <div style="display:flex; gap:10px;">
                <input type="text" id="make" placeholder="Marca (ej. Ferrari)" required>
                <input type="text" id="model" placeholder="Modelo (ej. F8)" required>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="year" placeholder="A√±o" required>
                <input type="number" id="horsepower" placeholder="HP" required>
                <input type="number" id="price" placeholder="Precio USD" required>
            </div>

            <label style="font-weight:bold; margin-top:15px; display:block;">Galer√≠a de Fotos:</label>
            <small style="color:#666;">Selecciona varias fotos. Se comprimir√°n autom√°ticamente.</small>
            <input type="file" id="imageInput" multiple accept="image/*" onchange="handleFiles()">
            
            <div id="preview-container">
                <p style="color:#aaa; font-size:0.9rem; margin:auto;">Las fotos aparecer√°n aqu√≠...</p>
            </div>

            <textarea id="description" rows="4" placeholder="Descripci√≥n detallada del veh√≠culo..."></textarea>
            
            <button type="submit" id="submitBtn" class="btn btn-success">Guardar Auto</button>
            <button type="button" onclick="resetForm()" class="btn" style="background:#6c757d; display:none;" id="cancelBtn">Cancelar</button>
        </form>
    </div>

    <div id="carsList" style="margin-top:30px;">
        <p>Cargando lista...</p>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let finalImages = []; 

        // --- FUNCI√ìN DE COMPRESI√ìN DE IM√ÅGENES üìâ ---
        // Esta funci√≥n toma un archivo grande y devuelve un Base64 peque√±o
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        // Creamos un canvas para redibujar la imagen m√°s peque√±a
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // Reducimos a m√°ximo 800px de ancho
                        const scaleSize = MAX_WIDTH / img.width;
                        
                        // Si la imagen es m√°s peque√±a que el l√≠mite, no la tocamos
                        if (scaleSize >= 1) {
                            resolve(event.target.result); 
                            return;
                        }

                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Exportamos como JPEG comprimido al 70% de calidad
                        // Esto reduce una imagen de 5MB a ~100KB (50 veces menos)
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedDataUrl);
                    };
                };
            });
        };

        // --- PROCESAMIENTO DE ARCHIVOS ---
        async function handleFiles() {
            const input = document.getElementById('imageInput');
            const container = document.getElementById('preview-container');
            
            if (!input.files.length) return;

            container.innerHTML = '<p style="color:#d4af37;">‚è≥ Comprimiendo im√°genes para la web...</p>';
            finalImages = [];

            // Usamos Promise.all para comprimir todas las fotos en paralelo
            const compressPromises = Array.from(input.files).map(file => compressImage(file));
            
            finalImages = await Promise.all(compressPromises);

            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            
            if (finalImages.length === 0) {
                 container.innerHTML = '<p style="color:#aaa;">Las fotos aparecer√°n aqu√≠...</p>';
                 return;
            }

            finalImages.forEach((imgSrc, index) => {
                const div = document.createElement('div');
                div.className = 'preview-wrapper';
                div.innerHTML = `
                    <img src="${imgSrc}" class="preview-img">
                    <div class="badge">${index + 1}</div>
                `;
                container.appendChild(div);
            });
        }

        // --- GUARDAR (POST/PUT) ---
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "Subiendo...";

            const id = document.getElementById('carId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/cars/${id}` : '/api/cars';

            const carData = {
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: document.getElementById('year').value,
                price: document.getElementById('price').value,
                horsepower: document.getElementById('horsepower').value,
                description: document.getElementById('description').value,
                images: finalImages
            };

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(carData)
                });

                if (res.ok) {
                    Swal.fire({
                        title: '¬°Excelente!',
                        text: 'Auto guardado correctamente',
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                    });
                    resetForm();
                    loadCars();
                } else {
                    const errData = await res.json();
                    Swal.fire('Error', errData.message || 'Error al guardar', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'La imagen sigue siendo muy pesada o fall√≥ la conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "Guardar Auto";
            }
        });

        // --- CARGAR LISTA ---
        async function loadCars() {
            const res = await fetch('/api/cars');
            const data = await res.json();
            const list = document.getElementById('carsList');
            list.innerHTML = '';
            
            data.data.forEach(car => {
                const carStr = JSON.stringify(car).replace(/'/g, "&#39;");
                const thumb = (car.images && car.images.length) ? car.images[0] : '';
                
                list.innerHTML += `
                    <div class="card">
                        <img src="${thumb}" class="thumb">
                        <div style="flex-grow:1"><b>${car.make} ${car.model}</b></div>
                        <button onclick='editCar(${carStr})' style="margin-right:5px; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="deleteCar('${car._id}')" style="background:red; color:white; border:none; padding:5px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        function editCar(car) {
            document.getElementById('formTitle').innerText = "Editando Auto: " + car.model;
            document.getElementById('carId').value = car._id;
            document.getElementById('make').value = car.make;
            document.getElementById('model').value = car.model;
            document.getElementById('year').value = car.year;
            document.getElementById('horsepower').value = car.horsepower;
            document.getElementById('price').value = car.price;
            document.getElementById('description').value = car.description || '';
            
            finalImages = car.images || [];
            renderPreview();

            document.getElementById('submitBtn').innerText = "Actualizar Auto";
            document.getElementById('cancelBtn').style.display = "inline-block";
            window.scrollTo(0,0);
        }

        async function deleteCar(id) {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "No podr√°s revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, borrar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch(`/api/cars/${id}`, { method: 'DELETE', headers: {'x-auth-token':token} });
                    loadCars();
                    Swal.fire('Borrado', 'El auto ha sido eliminado.', 'success');
                }
            })
        }

        function resetForm() {
            document.getElementById('carForm').reset();
            document.getElementById('formTitle').innerText = "Agregar / Editar Auto";
            document.getElementById('carId').value = '';
            finalImages = [];
            document.getElementById('preview-container').innerHTML = '<p style="color:#aaa;">Las fotos aparecer√°n aqu√≠...</p>';
            document.getElementById('submitBtn').innerText = "Guardar Auto";
            document.getElementById('cancelBtn').style.display = "none";
        }

        function logout() { localStorage.removeItem('token'); window.location.href='/login.html'; }
        loadCars();
    </script>
</body>
</html>