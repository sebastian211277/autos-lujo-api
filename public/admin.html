<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci贸n</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-container { background: white; padding: 20px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* Estilo para el input de archivos */
        input[type="file"] { padding: 10px; background: #f8f9fa; border: 1px dashed #ccc; cursor: pointer; }
        
        button { background: #28a745; color: white; border: none; padding: 12px 20px; cursor: pointer; border-radius: 4px; font-size: 1rem; width: 100%; margin-top: 10px; }
        button:hover { background: #218838; }
        .btn-logout { background: #dc3545; width: auto; margin: 0; }

        /* Previsualizaci贸n de fotos */
        #preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        /* Lista de autos */
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .thumb { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #eee; }
    </style>
</head>
<body>
    <div class="header">
        <h1> Gesti贸n de Inventario</h1>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi贸n</button>
    </div>

    <div class="form-container">
        <h3>Agregar Nuevo Auto</h3>
        <form id="carForm">
            <input type="text" id="make" placeholder="Marca (ej. Porsche)" required>
            <input type="text" id="model" placeholder="Modelo (ej. 911 GT3)" required>
            <div style="display:flex; gap:10px;">
                <input type="number" id="year" placeholder="A帽o" required>
                <input type="number" id="horsepower" placeholder="HP" required>
            </div>
            <input type="number" id="price" placeholder="Precio en USD" required>
            
            <label style="font-weight:bold; display:block; margin-top:10px;">Subir Fotos (M谩x 5):</label>
            <input type="file" id="imageInput" multiple accept="image/*" onchange="previewImages()">
            <div id="preview-container"></div>
            
            <textarea id="description" rows="3" placeholder="Descripci贸n del veh铆culo"></textarea>
            
            <button type="submit" id="submitBtn">Guardar Auto</button>
        </form>
    </div>

    <div id="carsList"><p>Cargando autos...</p></div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let base64Images = []; // Aqu铆 guardaremos las fotos convertidas

        // Funci贸n para leer los archivos y convertirlos a Base64
        function previewImages() {
            const input = document.getElementById('imageInput');
            const container = document.getElementById('preview-container');
            container.innerHTML = ''; // Limpiar previos
            base64Images = []; // Reiniciar array

            if (input.files) {
                // Limitamos a 5 fotos
                const files = Array.from(input.files).slice(0, 5);

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Guardamos el string base64
                        base64Images.push(e.target.result);
                        
                        // Creamos la miniatura visual
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-img';
                        container.appendChild(img);
                    };
                    reader.readAsDataURL(file); // 隆Aqu铆 ocurre la magia!
                });
            }
        }

        async function loadCars() {
            try {
                const res = await fetch('/api/cars');
                const data = await res.json();
                const list = document.getElementById('carsList');
                list.innerHTML = '';

                data.data.forEach(car => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    // Usamos la primera foto o un placeholder
                    const thumbSrc = (car.images && car.images.length > 0) ? car.images[0] : 'https://via.placeholder.com/100?text=No+Foto';
                    
                    div.innerHTML = `
                        <img src="${thumbSrc}" class="thumb" alt="auto">
                        <div>
                            <h3 style="margin:0;">${car.make} ${car.model}</h3>
                            <small>USD $${car.price.toLocaleString()}</small>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (error) { console.error(error); }
        }

        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Subiendo fotos...";
            btn.disabled = true;

            const newCar = {
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: document.getElementById('year').value,
                price: document.getElementById('price').value,
                horsepower: document.getElementById('horsepower').value,
                description: document.getElementById('description').value,
                images: base64Images // Enviamos las fotos convertidas
            };

            try {
                const res = await fetch('/api/cars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(newCar)
                });
                
                if (res.ok) { 
                    alert('隆Auto subido con 茅xito!'); 
                    loadCars(); 
                    e.target.reset(); 
                    document.getElementById('preview-container').innerHTML = '';
                    base64Images = [];
                } else { 
                    const err = await res.json();
                    alert('Error: ' + err.message); 
                }
            } catch (error) { 
                console.error(error); 
                alert('Error de conexi贸n o imagen muy pesada');
            } finally {
                btn.innerText = "Guardar Auto";
                btn.disabled = false;
            }
        });

        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }
        loadCars();
    </script>
</body>
</html>