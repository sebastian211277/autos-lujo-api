<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f4; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Formulario */
        .form-container { background: white; padding: 25px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #28a745; transition: 0.3s; }
        .form-container.editing { border-left-color: #ffc107; background: #fffbe6; } /* Color amarillo al editar */
        
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* Botones */
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-success { background: #28a745; width: 100%; margin-top: 10px; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: black; width: 100%; margin-top: 10px; display: none; } /* Oculto por defecto */
        .btn-cancel { background: #6c757d; margin-top: 10px; width: 100%; display: none; }
        .btn-danger { background: #dc3545; font-size: 0.8rem; }
        .btn-edit { background: #007bff; font-size: 0.8rem; margin-right: 5px; }
        .btn-logout { background: #343a40; }

        /* Lista de Autos */
        .cars-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: center; }
        .thumb { width: 100px; height: 70px; object-fit: cover; border-radius: 4px; background: #eee; }
        .actions { margin-left: auto; display: flex; flex-direction: column; gap: 5px; }
        
        /* Previsualizaci√≥n */
        #preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Gesti√≥n de Inventario</h1>
        <button class="btn btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="form-container" id="formContainer">
        <h3 id="formTitle">Agregar Nuevo Auto</h3>
        <form id="carForm">
            <input type="hidden" id="carId"> <div style="display:flex; gap:10px;">
                <input type="text" id="make" placeholder="Marca (ej. Ferrari)" required>
                <input type="text" id="model" placeholder="Modelo (ej. F8 Tributo)" required>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="year" placeholder="A√±o" required>
                <input type="number" id="horsepower" placeholder="HP" required>
                <input type="number" id="price" placeholder="Precio USD" required>
            </div>

            <label style="font-weight:bold; display:block; margin-top:10px;">Fotos:</label>
            <input type="file" id="imageInput" multiple accept="image/*" onchange="previewFiles()">
            <div id="preview-container"></div>
            <p style="font-size:0.8rem; color:#666;" id="imgHelpText">Selecciona nuevas fotos para reemplazarlas todas.</p>

            <textarea id="description" rows="3" placeholder="Descripci√≥n del veh√≠culo"></textarea>
            
            <button type="submit" id="btnSave" class="btn btn-success">Guardar Auto Nuevo</button>
            <button type="button" id="btnUpdate" class="btn btn-warning" onclick="submitUpdate()">Actualizar Auto</button>
            <button type="button" id="btnCancel" class="btn btn-cancel" onclick="resetForm()">Cancelar Edici√≥n</button>
        </form>
    </div>

    <div id="carsList" class="cars-grid">
        <p>Cargando inventario...</p>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        let base64Images = []; 

        // --- FUNCIONES DE IM√ÅGENES ---
        function previewFiles() {
            const input = document.getElementById('imageInput');
            const container = document.getElementById('preview-container');
            container.innerHTML = ''; 
            base64Images = []; 

            if (input.files) {
                Array.from(input.files).slice(0, 5).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        base64Images.push(e.target.result);
                        container.innerHTML += `<img src="${e.target.result}" class="preview-img">`;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // --- CARGAR AUTOS ---
        async function loadCars() {
            try {
                const res = await fetch('/api/cars');
                const data = await res.json();
                const list = document.getElementById('carsList');
                list.innerHTML = '';

                data.data.forEach(car => {
                    const thumb = (car.images && car.images.length > 0) ? car.images[0] : 'https://via.placeholder.com/100';
                    // Convertimos el objeto car a string para pasarlo a la funci√≥n de editar
                    // (Escapamos las comillas simples para que no rompa el HTML)
                    const carString = JSON.stringify(car).replace(/'/g, "&#39;");

                    list.innerHTML += `
                        <div class="card">
                            <img src="${thumb}" class="thumb">
                            <div style="flex-grow:1;">
                                <strong>${car.make} ${car.model}</strong><br>
                                <small>${car.year} | $${car.price.toLocaleString()}</small>
                            </div>
                            <div class="actions">
                                <button class="btn btn-edit" onclick='startEdit(${carString})'>‚úèÔ∏è</button>
                                <button class="btn btn-danger" onclick="deleteCar('${car._id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) { console.error(error); }
        }

        // --- MODO EDICI√ìN ---
        function startEdit(car) {
            // 1. Cambiar interfaz visual
            document.getElementById('formTitle').innerText = `Editando: ${car.make} ${car.model}`;
            document.getElementById('formContainer').classList.add('editing');
            
            document.getElementById('btnSave').style.display = 'none';
            document.getElementById('btnUpdate').style.display = 'block';
            document.getElementById('btnCancel').style.display = 'block';

            // 2. Llenar datos
            document.getElementById('carId').value = car._id;
            document.getElementById('make').value = car.make;
            document.getElementById('model').value = car.model;
            document.getElementById('year').value = car.year;
            document.getElementById('horsepower').value = car.horsepower;
            document.getElementById('price').value = car.price;
            document.getElementById('description').value = car.description || '';

            // 3. Mostrar im√°genes actuales
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            base64Images = car.images || []; // Mantener las im√°genes actuales por si no sube nuevas
            
            if(car.images) {
                car.images.forEach(imgUrl => {
                    container.innerHTML += `<img src="${imgUrl}" class="preview-img">`;
                });
            }
            
            // Scroll hacia arriba para ver el formulario
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('carForm').reset();
            document.getElementById('formTitle').innerText = 'Agregar Nuevo Auto';
            document.getElementById('formContainer').classList.remove('editing');
            document.getElementById('preview-container').innerHTML = '';
            base64Images = [];

            document.getElementById('btnSave').style.display = 'block';
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
        }

        // --- GUARDAR NUEVO (POST) ---
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const carData = getFormData();
            
            try {
                const res = await fetch('/api/cars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(carData)
                });
                if(res.ok) { alert('Creado!'); resetForm(); loadCars(); }
            } catch (err) { alert('Error al crear'); }
        });

        // --- ACTUALIZAR EXISTENTE (PUT) ---
        async function submitUpdate() {
            const id = document.getElementById('carId').value;
            const carData = getFormData();

            try {
                const res = await fetch(`/api/cars/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(carData)
                });
                if(res.ok) { alert('Actualizado!'); resetForm(); loadCars(); }
                else { alert('Error al actualizar'); }
            } catch (err) { alert('Error de conexi√≥n'); }
        }

        // --- ELIMINAR (DELETE) ---
        async function deleteCar(id) {
            if(!confirm('¬øSeguro que quieres eliminar este auto?')) return;
            
            try {
                const res = await fetch(`/api/cars/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-auth-token': token }
                });
                if(res.ok) { loadCars(); }
                else { alert('Error al eliminar'); }
            } catch (err) { console.error(err); }
        }

        function getFormData() {
            return {
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: document.getElementById('year').value,
                price: document.getElementById('price').value,
                horsepower: document.getElementById('horsepower').value,
                description: document.getElementById('description').value,
                images: base64Images
            };
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }
        
        loadCars(); // Iniciar
    </script>
</body>
</html>